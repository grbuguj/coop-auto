<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>식단표 변환기</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
      font-family: 'Noto Sans KR', sans-serif;
      color: #2e7d32;
    }
    .container {
      max-width: 1200px;
      margin-top: 30px;
    }
    h2 {
      font-weight: 700;
      color: #1b5e20;
    }
    textarea, input, select {
      font-size: 14px;
      font-family: monospace;
      border-radius: 10px;
      border: 1px solid #c8e6c9;
      padding: 10px;
      transition: all 0.2s ease;
    }
    textarea:focus, input:focus, select:focus {
      outline: none;
      border-color: #66bb6a;
      box-shadow: 0 0 8px rgba(102, 187, 106, 0.4);
    }
    .section-title {
      font-weight: bold;
      margin-bottom: 8px;
      color: #388e3c;
    }

    body, input, select, textarea, button {
      font-family: 'Noto Sans KR', sans-serif;
    }

    /* placeholder 글씨도 통일 */
    input::placeholder,
    textarea::placeholder {
      font-family: 'Noto Sans KR', sans-serif;
    }

    .shadow {
      box-shadow: 0 8px 20px rgba(56, 142, 60, 0.15) !important;
    }
    table.meal-table {
      text-align: center;
      background: #ffffff;
      border-radius: 12px;
      overflow: hidden;
      border: 2px solid #c8e6c9;
    }
    table.meal-table th {
      background: #a5d6a7;
      font-weight: 600;
      color: #1b5e20;
    }
    table.meal-table td {
      width: 90px;
      height: 55px;
      cursor: pointer;
      background: #ffffff;
      border: 1px solid #c8e6c9;
      transition: background 0.2s, color 0.2s, transform 0.1s;
      user-select: none;
    }
    table.meal-table td.active {
      background: #43a047;
      color: #ffffff;
      font-weight: bold;
      transform: scale(1.05);
      border: 1px solid #c8e6c9; /* 원래 테두리 유지 */
      box-shadow: inset 0 0 0 1px #ffffff; /* ✅ 안쪽에 흰색 라인 추가 */
    }

    table.meal-table td:hover {
      background: #e8f5e9;
    }
    .btn-primary {
      background: #43a047;
      border: none;
      font-weight: bold;
      border-radius: 12px;
      transition: background 0.2s, transform 0.1s;
    }
    .btn-primary:hover {
      background: #2e7d32;
      transform: translateY(-2px);
    }
    .btn-primary:active {
      background: #1b5e20;
      transform: scale(0.98);
    }
    .hidden {
      display: none;
    }
    #resultBox {
      background: #f9fff9;
      border: 1px solid #c8e6c9;
      border-radius: 12px;
      color: #1b5e20;
      font-size: 14px;
      padding: 12px;
      white-space: pre;        /* 줄바꿈 그대로, 자동 개행 없음 */
      overflow-x: auto;        /* 긴 줄은 가로 스크롤 */
      font-family: monospace;  /* 가독성 좋은 고정폭 폰트 유지 */
    }
    label.form-label {
      font-weight: 600;
      color: #2e7d32;
    }
  </style>
</head>
<body>
<div class="container">
  <h2 class="mb-4 text-center">🌱 생협 식단표 자동 변환기 Ver 2.0</h2>

  <!-- 좌우 컬럼 동일 높이 -->
  <div class="row align-items-stretch">
    <!-- 왼쪽 -->
    <div class="col-md-6 d-flex">
      <form id="menuForm" class="shadow p-4 bg-white rounded flex-fill d-flex flex-column">
        <div class="mb-3">
          <label class="form-label">년도:</label>
          <input type="number" class="form-control" name="year" value="2025" required>
        </div>

        <div class="mb-3">
          <label class="form-label">식당 선택:</label>
          <select class="form-select" name="cafeteria" id="cafeteriaSelect">
            <option value="학생식당">학생식당</option>
            <option value="2호관식당">2호관식당</option>
            <option value="제1기숙사식당">제1기숙사식당</option>
            <option value="사범대식당" selected>사범대식당</option>
          </select>
        </div>

        <!-- 학생식당 -->
        <div class="mb-3 meal-table-wrapper hidden">
          <label class="form-label">요일별 코너 선택 (학생식당):</label>
          <table class="table meal-table cafeteriaTable" data-cafeteria="학생식당">
            <thead>
            <tr>
              <th>끼니</th>
              <th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th><th>일</th>
            </tr>
            </thead>
            <tbody>
            <tr><td>조식</td><td data-day="mon" data-meal="breakfast"></td><td data-day="tue" data-meal="breakfast"></td><td data-day="wed" data-meal="breakfast"></td><td data-day="thu" data-meal="breakfast"></td><td data-day="fri" data-meal="breakfast"></td><td data-day="sat" data-meal="breakfast"></td><td data-day="sun" data-meal="breakfast"></td></tr>
            <tr><td>중식-1코너</td><td data-day="mon" data-meal="lunch_1"></td><td data-day="tue" data-meal="lunch_1"></td><td data-day="wed" data-meal="lunch_1"></td><td data-day="thu" data-meal="lunch_1"></td><td data-day="fri" data-meal="lunch_1"></td><td data-day="sat" data-meal="lunch_1"></td><td data-day="sun" data-meal="lunch_1"></td></tr>
            <tr><td>중식-2코너</td><td data-day="mon" data-meal="lunch_2"></td><td data-day="tue" data-meal="lunch_2"></td><td data-day="wed" data-meal="lunch_2"></td><td data-day="thu" data-meal="lunch_2"></td><td data-day="fri" data-meal="lunch_2"></td><td data-day="sat" data-meal="lunch_2"></td><td data-day="sun" data-meal="lunch_2"></td></tr>
            <tr><td>중식-3코너</td><td data-day="mon" data-meal="lunch_3"></td><td data-day="tue" data-meal="lunch_3"></td><td data-day="wed" data-meal="lunch_3"></td><td data-day="thu" data-meal="lunch_3"></td><td data-day="fri" data-meal="lunch_3"></td><td data-day="sat" data-meal="lunch_3"></td><td data-day="sun" data-meal="lunch_3"></td></tr>
            <tr><td>중식-4코너</td><td data-day="mon" data-meal="lunch_4"></td><td data-day="tue" data-meal="lunch_4"></td><td data-day="wed" data-meal="lunch_4"></td><td data-day="thu" data-meal="lunch_4"></td><td data-day="fri" data-meal="lunch_4"></td><td data-day="sat" data-meal="lunch_4"></td><td data-day="sun" data-meal="lunch_4"></td></tr>
            <tr><td>중식-5코너A</td><td data-day="mon" data-meal="lunch_5a"></td><td data-day="tue" data-meal="lunch_5a"></td><td data-day="wed" data-meal="lunch_5a"></td><td data-day="thu" data-meal="lunch_5a"></td><td data-day="fri" data-meal="lunch_5a"></td><td data-day="sat" data-meal="lunch_5a"></td><td data-day="sun" data-meal="lunch_5a"></td></tr>
            <tr><td>중식-5코너B</td><td data-day="mon" data-meal="lunch_5b"></td><td data-day="tue" data-meal="lunch_5b"></td><td data-day="wed" data-meal="lunch_5b"></td><td data-day="thu" data-meal="lunch_5b"></td><td data-day="fri" data-meal="lunch_5b"></td><td data-day="sat" data-meal="lunch_5b"></td><td data-day="sun" data-meal="lunch_5b"></td></tr>
            <tr><td>석식</td><td data-day="mon" data-meal="dinner"></td><td data-day="tue" data-meal="dinner"></td><td data-day="wed" data-meal="dinner"></td><td data-day="thu" data-meal="dinner"></td><td data-day="fri" data-meal="dinner"></td><td data-day="sat" data-meal="dinner"></td><td data-day="sun" data-meal="dinner"></td></tr>
            </tbody>
          </table>
        </div>

        <!-- 2호관식당 -->
        <div class="mb-3 meal-table-wrapper hidden">
          <label class="form-label">요일별 코너 선택 (2호관식당):</label>
          <table class="table meal-table cafeteriaTable" data-cafeteria="2호관식당">
            <thead>
            <tr>
              <th>끼니</th>
              <th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th><th>일</th>
            </tr>
            </thead>
            <tbody>
            <tr><td>조식</td><td data-day="mon" data-meal="breakfast"></td><td data-day="tue" data-meal="breakfast"></td><td data-day="wed" data-meal="breakfast"></td><td data-day="thu" data-meal="breakfast"></td><td data-day="fri" data-meal="breakfast"></td><td data-day="sat" data-meal="breakfast"></td><td data-day="sun" data-meal="breakfast"></td></tr>
            <tr><td>중식-1코너</td><td data-day="mon" data-meal="lunch_1"></td><td data-day="tue" data-meal="lunch_1"></td><td data-day="wed" data-meal="lunch_1"></td><td data-day="thu" data-meal="lunch_1"></td><td data-day="fri" data-meal="lunch_1"></td><td data-day="sat" data-meal="lunch_1"></td><td data-day="sun" data-meal="lunch_1"></td></tr>
            <tr><td>석식</td><td data-day="mon" data-meal="dinner"></td><td data-day="tue" data-meal="dinner"></td><td data-day="wed" data-meal="dinner"></td><td data-day="thu" data-meal="dinner"></td><td data-day="fri" data-meal="dinner"></td><td data-day="sat" data-meal="dinner"></td><td data-day="sun" data-meal="dinner"></td></tr>
            </tbody>
          </table>
        </div>

        <!-- 제1기숙사식당 -->
        <div class="mb-3 meal-table-wrapper hidden">
          <label class="form-label">요일별 코너 선택 (제1기숙사식당):</label>
          <table class="table meal-table cafeteriaTable" data-cafeteria="제1기숙사식당">
            <thead>
            <tr>
              <th>끼니</th>
              <th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th><th>일</th>
            </tr>
            </thead>
            <tbody>
            <tr><td>조식</td><td data-day="mon" data-meal="breakfast"></td><td data-day="tue" data-meal="breakfast"></td><td data-day="wed" data-meal="breakfast"></td><td data-day="thu" data-meal="breakfast"></td><td data-day="fri" data-meal="breakfast"></td><td data-day="sat" data-meal="breakfast"></td><td data-day="sun" data-meal="breakfast"></td></tr>
            <tr><td>중식-1코너</td><td data-day="mon" data-meal="lunch_1"></td><td data-day="tue" data-meal="lunch_1"></td><td data-day="wed" data-meal="lunch_1"></td><td data-day="thu" data-meal="lunch_1"></td><td data-day="fri" data-meal="lunch_1"></td><td data-day="sat" data-meal="lunch_1"></td><td data-day="sun" data-meal="lunch_1"></td></tr>
            <tr><td>석식</td><td data-day="mon" data-meal="dinner"></td><td data-day="tue" data-meal="dinner"></td><td data-day="wed" data-meal="dinner"></td><td data-day="thu" data-meal="dinner"></td><td data-day="fri" data-meal="dinner"></td><td data-day="sat" data-meal="dinner"></td><td data-day="sun" data-meal="dinner"></td></tr>
            </tbody>
          </table>
        </div>

        <!-- 사범대식당 -->
        <div class="mb-3 meal-table-wrapper">
          <label class="form-label">요일별 코너 선택 (사범대식당):</label>
          <table class="table meal-table cafeteriaTable" data-cafeteria="사범대식당">
            <thead>
            <tr>
              <th>끼니</th>
              <th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th><th>일</th>
            </tr>
            </thead>
            <tbody>
            <tr><td>조식</td><td data-day="mon" data-meal="breakfast"></td><td data-day="tue" data-meal="breakfast"></td><td data-day="wed" data-meal="breakfast"></td><td data-day="thu" data-meal="breakfast"></td><td data-day="fri" data-meal="breakfast"></td><td data-day="sat" data-meal="breakfast"></td><td data-day="sun" data-meal="breakfast"></td></tr>
            <tr><td>중식-1코너</td><td data-day="mon" data-meal="lunch_1"></td><td data-day="tue" data-meal="lunch_1"></td><td data-day="wed" data-meal="lunch_1"></td><td data-day="thu" data-meal="lunch_1"></td><td data-day="fri" data-meal="lunch_1"></td><td data-day="sat" data-meal="lunch_1"></td><td data-day="sun" data-meal="lunch_1"></td></tr>
            <tr><td>중식-2코너</td><td data-day="mon" data-meal="lunch_2"></td><td data-day="tue" data-meal="lunch_2"></td><td data-day="wed" data-meal="lunch_2"></td><td data-day="thu" data-meal="lunch_2"></td><td data-day="fri" data-meal="lunch_2"></td><td data-day="sat" data-meal="lunch_2"></td><td data-day="sun" data-meal="lunch_2"></td></tr>
            <tr><td>석식</td><td data-day="mon" data-meal="dinner"></td><td data-day="tue" data-meal="dinner"></td><td data-day="wed" data-meal="dinner"></td><td data-day="thu" data-meal="dinner"></td><td data-day="fri" data-meal="dinner"></td><td data-day="sat" data-meal="dinner"></td><td data-day="sun" data-meal="dinner"></td></tr>
            </tbody>
          </table>
        </div>

        <div class="mb-3">
          <label class="form-label">원본 텍스트:</label>
          <textarea class="form-control" name="rawText" rows="8" id="rawText"></textarea>
        </div>
      </form>
    </div>

    <!-- 오른쪽 -->
    <div class="col-md-6 d-flex">
      <div class="shadow p-4 bg-white rounded flex-fill d-flex flex-column">
        <div class="d-flex mb-2 align-items-center">
          <button id="convertBtn" class="btn btn-success flex-grow-1 me-2">변환하기</button>
          <button id="copyBtn" class="btn btn-outline-secondary me-2">결과 복사</button>
          <span id="copyMsg" class="text-success small" style="display:none;">복사 성공!</span>
        </div>
        <h3 class="section-title">결과:</h3>
        <textarea id="resultBox" class="form-control flex-grow-1" readonly>여기에 결과가 표시됩니다. Made by 재웅</textarea>
      </div>
    </div>
  </div>
</div>

<script>
  let selectedValues = [];
  let isMouseDown = false;
  let dragMode = null;

  function updateSelectedValues() {
    const activeCells = document.querySelectorAll('.cafeteriaTable:not(.hidden) td.active[data-day]');
    selectedValues = Array.from(activeCells).map(cell => ({
      day: cell.dataset.day,
      meal: cell.dataset.meal
    }));
  }

  document.getElementById("convertBtn").addEventListener("click", async function () {
    const formData = {
      year: form.querySelector('input[name="year"]').value,
      cafeteria: form.querySelector('select[name="cafeteria"]').value,
      rawText: document.getElementById('rawText').value,
      selectedMeals: selectedValues
    };
    try {
      const res = await fetch('/convert-ajax', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
      const text = await res.text();
      resultBox.value = text;
    } catch (err) {
      resultBox.value = '오류 발생: ' + err;
    }
  });


  function attachCellEvents() {
    const visibleCells = document.querySelectorAll('.cafeteriaTable:not(.hidden) td[data-day]');
    visibleCells.forEach(cell => {
      const newCell = cell.cloneNode(true);
      cell.parentNode.replaceChild(newCell, cell);
    });
    const freshCells = document.querySelectorAll('.cafeteriaTable:not(.hidden) td[data-day]');
    freshCells.forEach(cell => {
      cell.addEventListener('mousedown', () => {
        isMouseDown = true;
        if (cell.classList.contains('active')) {
          dragMode = "remove";
          cell.classList.remove('active');
        } else {
          dragMode = "add";
          cell.classList.add('active');
        }
        updateSelectedValues();
      });
      cell.addEventListener('mouseover', () => {
        if (isMouseDown) {
          if (dragMode === "add") cell.classList.add('active');
          else if (dragMode === "remove") cell.classList.remove('active');
          updateSelectedValues();
        }
      });
    });
  }

  document.body.addEventListener('mouseup', () => {
    isMouseDown = false;
    dragMode = null;
  });

  const cafeteriaSelect = document.getElementById('cafeteriaSelect');
  const cafeteriaTables = document.querySelectorAll('.cafeteriaTable');

  cafeteriaSelect.addEventListener('change', () => {
    // 모든 테이블 숨기기
    cafeteriaTables.forEach(t => {
      t.closest('.meal-table-wrapper').classList.add('hidden');
      // 모든 td에서 active 제거
      t.querySelectorAll('td.active').forEach(td => td.classList.remove('active'));
    });

    // 선택한 식당만 보이기
    const targetTable = document.querySelector(`.cafeteriaTable[data-cafeteria="${cafeteriaSelect.value}"]`);
    if (targetTable) {
      targetTable.closest('.meal-table-wrapper').classList.remove('hidden');
    }

    // 상태 초기화
    isMouseDown = false;
    dragMode = null;
    selectedValues = [];
    updateSelectedValues();
    attachCellEvents();
  });


  const form = document.getElementById('menuForm');
  const resultBox = document.getElementById('resultBox');

  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    const formData = {
      year: form.querySelector('input[name="year"]').value,
      cafeteria: form.querySelector('select[name="cafeteria"]').value,
      rawText: document.getElementById('rawText').value,
      selectedMeals: selectedValues
    };
    try {
      const res = await fetch('/convert-ajax', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });
      const text = await res.text();
      resultBox.value = text;
    } catch (err) {
      resultBox.value = '오류 발생: ' + err;
    }
  });

  // 복사 버튼 기능
  document.getElementById("copyBtn").addEventListener("click", () => {
    const resultText = document.getElementById("resultBox").value;
    if (!resultText.trim()) return;

    navigator.clipboard.writeText(resultText).then(() => {
      const msg = document.getElementById("copyMsg");
      msg.style.display = "inline";     // 표시
      setTimeout(() => {
        msg.style.display = "none";     // 2초 뒤 숨기기
      }, 2000);
    }).catch(err => {
      console.error("복사 실패:", err);
    });
  });



  attachCellEvents();
</script>
</body>
</html>
